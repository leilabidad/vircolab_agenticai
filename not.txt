import pandas as pd

patients = pd.read_csv("patients.csv.gz", usecols=['subject_id','dob','gender'])
admissions = pd.read_csv("admissions.csv.gz", usecols=['subject_id','hadm_id','hospital_expire_flag'])
cxr = pd.read_csv("mimic-cxr-2.0.0-metadata.csv.gz", usecols=['subject_id','hadm_id','study_id','StudyDate','StudyTime'])

patients['dob'] = pd.to_datetime(patients['dob'])
cxr['study_datetime'] = pd.to_datetime(
    cxr['StudyDate'].astype(str) + cxr['StudyTime'].astype(str).str.zfill(6),
    format="%Y%m%d%H%M%S",
    errors="coerce"
)

base = admissions.merge(patients, on='subject_id', how='left')
base['age'] = 2025 - base['dob'].dt.year
base = base[(base['age'] >= 0) & (base['age'] <= 120)]
base['outcome'] = base['hospital_expire_flag']

final = cxr.merge(base[['subject_id','hadm_id','age','gender','outcome']], on=['subject_id','hadm_id'], how='left')
final = final[['study_id','subject_id','hadm_id','age','gender','outcome']]
final = final.dropna(subset=['study_id','subject_id'])
final = final.drop_duplicates(subset='study_id')
final['gender'] = final['gender'].map({'M':1,'F':0})

final.to_csv("mimic_llm_study_level_ultralight.csv", index=False)
